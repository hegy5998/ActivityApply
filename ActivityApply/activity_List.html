<!--放置分頁內容的地方，會被放在ID=hiddenresult的裡面-->

<script>
    //初始設定搜尋字串
    var search_title = "%%"
    //#region 初始化
    $(document).ready(function () {
        //抓取網址列設定值
        //alert($.url().param("act_class"));
        //抓取要搜尋的分類
        //var act_class = $("#act_class").val();
        var act_class = $.url().param("act_class");
        //產生所有活動
        searchActivityAllList(search_title, act_class);
    })
    //#endregion

    //#region 搜尋按鈕事件
    $("#search_btn").click(function () {
        //抓取要搜尋的分類
        var act_class = $("#act_class").val();
        setbread("",act_class);
        //抓取要搜尋的字串
        var searct_txt = $("#search_txt").val();
        //以空白切割字串
        var act_title = searct_txt.split(" ");
        search_title = "";
        //迴圈把切割完的字串在串接起來，資料庫使用LIKE搜尋
        for (var temp = 0 ; temp < act_title.length; temp++) {
            if (act_title[temp] != " ")
                search_title += "%" + act_title[temp];
        }
        search_title += '%';
        //清空分頁內容
        $("#hiddenresult").html("");
        $("#Searchresult").html("");
        searchActivityAllList(search_title, act_class);


        //設定有幾個分頁，要除以你一個分頁要顯示幾筆資料
        var num_entries = $("#hiddenresult div.result").length / 8;
        // 創建分頁
        $("#Pagination").pagination(num_entries, {
            items_per_page: 1, //每頁顯示幾項
            num_edge_entries: 1, //邊緣頁數
            num_display_entries: 50, //主體頁數
            callback: pageselectCallback,
            prev_text: "前一頁",
            next_text: "下一頁"
        });

        function pageselectCallback(page_index, jq) {
            //var new_content = $("#hiddenresult div.result:eq(" + page_index + ")").clone();
            //$("#Searchresult").empty().append(new_content); //装载对应分页的内容
            //設定一個分頁要顯示幾筆資料
            var items_per_page = 8;
            var max_elem = Math.min((page_index + 1) * items_per_page, $("#hiddenresult div.result").length);
            $("#Searchresult").html("");
            //判斷現在在第幾個分頁並顯示其內容
            for (var i = page_index * items_per_page; i < max_elem; i++) {
                $("#Searchresult").append($("#hiddenresult div.result:eq(" + i + ")").clone());
            }
            return false;
        }
    })
    //#endregion

    //#region 搜尋活動事件
    function searchActivityAllList(act_title, act_class) {
        //船JSON字串到後台去抓資料
        var jsondata = { "act_title": act_title, "act_class": act_class }
        $.ajax({
            type: 'post',
            traditional: true,
            data: JSON.stringify(jsondata),
            //傳送資料到後台為getActivityAllList的function
            url: '/activity_List.aspx/getActivityAllList',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            async: false,
            //成功時
            success: function (result) {
                // 加入活動
                addActivity(result.d);
            },
            //失敗時
            error: function () {
                return false;
            }
        });
    }
    //#endregion

    //#region 把搜尋到的資料加到分頁中
    function addActivity(ActivityInfo) {
        //轉換活動的JSON字串成JSON物件
        var ActivityInfo = JSON.parse(ActivityInfo);
        //產生場次
        for (var count = 0 ; count < ActivityInfo.length ; count++) {
            $("#hiddenresult").append('<div class="result">\
                                            <div class="row">\
                                                <div class="content-panel">\
                                                    <h3><a target="_self" href="activity.aspx?act_idn=' + ActivityInfo[count].act_idn + '">' + ActivityInfo[count].act_title + '</a></h3>\
                                                    <label>活動日期：' + dateReviver(ActivityInfo[count].as_date_start) + ' ~ ' + dateReviver(ActivityInfo[count].as_date_end) + '</label>\
                                                    <br />\
                                                    <label>報名日期：' + dateReviver(ActivityInfo[count].as_apply_start) + ' ~ ' + dateReviver(ActivityInfo[count].as_apply_end) + '</label>\
                                                </div>\
                                            </div>\
                                        </div>');
        }
        //後臺轉換DateTime格式時會把他轉成字串，使用JSON.parse會把它當成子串解析，需要在做轉換與切割成我們要的格式
        function dateReviver(datavalue) {
            if (datavalue != null) {
                var datavalue = datavalue.split("T");
                return datavalue[0] + " " + datavalue[1].substring(0, 5);
            }
            else
                return "";
        };
    }
    //#endregion
</script>